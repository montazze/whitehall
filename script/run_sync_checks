#!/usr/bin/env ruby

$LOAD_PATH << File.expand_path("../", File.dirname(__FILE__))
require_relative '../config/environment'

require 'optparse'

options = {}
OptionParser.new do |opts|
  opts.banner = "Usage: run_sync_checks [options] ModelName"

  opts.on("-o", "--output FILE", "output results to a CSV file") do |f|
    options[:output] = f
  end

  opts.on("-f", "--only-failures", "only run with the failures from the last run") do |f|
    file = Rails.root.join("tmp/.sync_check_failures")
    if File.exist? file
      options[:ids] = File.readlines(file).map(&:to_i).uniq
    end
  end
end.parse!

document_format = "SyncChecker::Formats::#{ARGV[0]}Check".constantize
documents = (
  if options[:ids]
    document_format.scope_with_ids(options[:ids])
  else
    document_format.scope
  end
)

checks = documents.map { |doc| document_format.new(doc) }
checker = SyncChecker::SyncCheck.new(checks, csv_file_path: options[:output])
checker.run
